@model IEnumerable<WebsiteBanHang.Models.DanhMuc>
@{
    ViewData["Title"] = "Danh Sách Danh Mục";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<link rel="stylesheet" href="~/css/Admin_DanhMuc.css">

<h2 class="content-title">Danh Sách Danh Mục</h2>

<!-- Khu vực tìm kiếm -->
<div class="search-container">
    <form asp-action="Index" asp-controller="DanhMuc" method="get">
        <div class="search-wrapper">
            <input type="text" id="nhapTuKhoa" name="tuKhoaTimKiem" class="search-input" placeholder="Tìm kiếm danh mục..." value="@ViewData["tuKhoaTimKiem"]" autocomplete="off" />
            <input type="hidden" name="chonTrangThai" value="@ViewData["chonTrangThai"]" />
            <input type="hidden" name="chonDeXuat" value="@ViewData["chonDeXuat"]" />
            <button type="submit" class="search-btn">Tìm</button>
        </div>
        <div id="danhSachGoiY" class="suggestions"></div>
    </form>
</div>

<!-- Thông báo -->
@if (ViewBag.KetQuaTimKiem != null)
{
    <p class="alert alert-error">@ViewBag.KetQuaTimKiem</p>
    <h4 class="sub-text">Gợi ý danh mục</h4>
}
@if (TempData["Message"] != null)
{
    <p class="alert alert-success">@TempData["Message"]</p>
}
@if (TempData["Error"] != null)
{
    <p class="alert alert-error">@TempData["Error"]</p>
}

<!-- Nút Thêm -->
<div class="action-bar">
    <form asp-action="Add" asp-controller="DanhMuc" method="get">
        @Html.AntiForgeryToken()
        <button type="submit" class="action-btn add-btn">Thêm danh mục mới</button>
    </form>
</div>

<!-- Bảng danh sách danh mục -->
<div class="table-container">
    <form asp-action="DeleteMultiple" asp-controller="DanhMuc" method="post" id="danhmucForm">
        @Html.AntiForgeryToken()
        <table class="data-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll" /></th>
                    <th>Mã Danh Mục</th>
                    <th>Tên Danh Mục</th>
                    <th>Trạng Thái</th>
                    <th>Đề Xuất Trang Chủ</th>
                    <th>Hành Động</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var danhmuc in Model)
                {
                    <tr data-category-id="@danhmuc.MaDM">
                        <td>
                            <input type="checkbox" class="select-item" name="selectedDanhMucMaDM" value="@danhmuc.MaDM" />
                        </td>
                        <td>@danhmuc.MaDM</td>
                        <td>@danhmuc.TenDM</td>
                        <td>
                            <a href="#" class="status-link @(danhmuc.TTHienThi ? "status-on" : "status-off")" data-id="@danhmuc.MaDM" data-status="@danhmuc.TTHienThi">
                                @(danhmuc.TTHienThi ? "Bật" : "Tắt")
                            </a>
                        </td>
                        <td>
                            <a href="#" class="status-link @(danhmuc.TTDeXuat ? "status-on" : "status-off")" data-id="@danhmuc.MaDM" data-dexuat="@danhmuc.TTDeXuat">
                                @(danhmuc.TTDeXuat ? "Bật" : "Tắt")
                            </a>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a asp-action="Display" asp-controller="DanhMuc" asp-route-maDM="@danhmuc.MaDM" class="action-link view-link">Xem</a>
                                <a asp-action="Update" asp-controller="DanhMuc" asp-route-maDM="@danhmuc.MaDM" class="action-link edit-link">Sửa</a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </form>

    <!-- Thanh cố định -->
    <div class="fixed-bar">
        <form asp-action="Index" asp-controller="DanhMuc" method="get" id="filterForm">
            <input type="hidden" name="tuKhoaTimKiem" value="@Html.Encode(ViewData["tuKhoaTimKiem"])" />
            <select name="chonTrangThai" onchange="this.form.submit()" class="filter-select">
                <option value="batHienThi" selected="@(ViewData["chonTrangThai"]?.ToString() == "batHienThi" ? "selected" : null)">Danh mục bật hiển thị</option>
                <option value="tatHienThi" selected="@(ViewData["chonTrangThai"]?.ToString() == "tatHienThi" ? "selected" : null)">Danh mục tắt hiển thị</option>
                <option value="tatCa" selected="@(ViewData["chonTrangThai"]?.ToString() == "tatCa" ? "selected" : null)">Tất cả danh mục</option>
            </select>
            <select name="chonDeXuat" onchange="this.form.submit()" class="filter-select">
                <option value="batDeXuat" selected="@(ViewData["chonDeXuat"]?.ToString() == "batDeXuat" ? "selected" : null)">Danh mục đề xuất</option>
                <option value="tatDeXuat" selected="@(ViewData["chonDeXuat"]?.ToString() == "tatDeXuat" ? "selected" : null)">Danh mục không đề xuất</option>
                <option value="tatCaDeXuat" selected="@(ViewData["chonDeXuat"]?.ToString() == "tatCaDeXuat" ? "selected" : null)">Tất cả đề xuất</option>
            </select>
        </form>
        <button type="button" class="action-btn update-btn" id="updateTrangThaiBtn" disabled>Cập nhật trạng thái</button>
        <button type="button" class="action-btn update-btn" id="updateTrangThaiDeXuatBtn" disabled>Cập nhật trạng thái đề xuất</button>
        <button type="button" class="action-btn delete-btn" id="deleteSelectedBtn" disabled>Xóa/Ẩn</button>
    </div>
</div>

<!-- Modal xác nhận xóa -->
<div class="modal" id="confirmDeleteModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận xử lý</h5>
                <button type="button" class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xử lý các danh mục sau không?</p>
                <h6>Các danh mục sẽ bị xóa (danh mục không có sản phẩm):</h6>
                <ul id="danhmucToDelete"></ul>
                <h6>Các danh mục sẽ bị ẩn (danh mục có chứa sản phẩm):</h6>
                <ul id="danhmucToHide"></ul>
                <p class="alert alert-error">Lưu ý: Để xóa danh mục có sản phẩm, chuyển tất cả sản phẩm sang danh mục khác qua "Chi Tiết Sản Phẩm".</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn cancel-btn" data-modal-close>Hủy</button>
                <button type="submit" form="danhmucForm" formaction="@Url.Action("DeleteMultiple", "DanhMuc")" class="modal-btn hide-btn">Ẩn</button>
                <button type="submit" form="danhmucForm" formaction="@Url.Action("DeleteMultiple", "DanhMuc", new { isDelete = true })" class="modal-btn delete-btn">Xóa</button>
                <button type="submit" form="danhmucForm" formaction="@Url.Action("XemChiTietSanPhamTheoDanhMuc", "DanhMuc")" class="modal-btn detail-btn">Chi Tiết Sản Phẩm</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal thông báo xóa -->
<div class="modal" id="thongBaoXoaModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xử Lý Danh Mục Thành Công</h5>
                <button type="button" class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <p id="thongBaoXoaTinNhan"></p>
                <h6>Danh sách danh mục đã xóa:</h6>
                <ul id="danhSachXoa"></ul>
                <h6>Danh sách danh mục đã ẩn:</h6>
                <ul id="danhSachAn"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn cancel-btn" data-modal-close>Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal thay đổi trạng thái hiển thị -->
<div class="modal" id="statusModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thay đổi trạng thái hiển thị</h5>
                <button type="button" class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <form id="statusForm" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="maDM" id="statusId" />
                    <input type="hidden" name="chonTrangThai" id="chonTrangThai" value="@ViewData["chonTrangThai"]" />
                    <p>Trạng thái hiện tại: <span id="currentStatus"></span></p>
                    <label for="statusSelect">Chọn trạng thái mới:</label>
                    <select name="status" id="statusSelect" class="filter-select">
                        <option value="true">Bật</option>
                        <option value="false">Tắt</option>
                    </select>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn cancel-btn" data-modal-close>Hủy</button>
                <button type="button" id="updateStatusBtn" class="modal-btn confirm-btn">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal thay đổi trạng thái đề xuất -->
<div class="modal" id="deXuatModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thay đổi trạng thái đề xuất</h5>
                <button type="button" class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <form id="deXuatForm" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="maDM" id="deXuatId" />
                    <input type="hidden" name="chonDeXuat" id="chonDeXuat" value="@ViewData["chonDeXuat"]" />
                    <p>Trạng thái đề xuất hiện tại: <span id="currentDeXuat"></span></p>
                    <label for="deXuatSelect">Chọn trạng thái mới:</label>
                    <select name="status" id="deXuatSelect" class="filter-select">
                        <option value="true">Bật</option>
                        <option value="false">Tắt</option>
                    </select>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn cancel-btn" data-modal-close>Hủy</button>
                <button type="button" id="updateDeXuatBtn" class="modal-btn confirm-btn">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal cập nhật trạng thái hiển thị hàng loạt -->
<div class="modal" id="updateTrangThaiModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cập nhật trạng thái hiển thị</h5>
                <button type="button" class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <form id="updateTrangThaiForm" method="post" asp-action="CapNhatTrangThai" asp-controller="DanhMuc">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="selectedDanhMucMaDM" id="selectedDanhMucMaDMTrangThai" />
                    <p>Các danh mục được chọn sẽ được cập nhật sang trạng thái hiển thị mới.</p>
                    <label for="newTrangThai">Chọn trạng thái mới:</label>
                    <select name="newTrangThai" id="newTrangThai" class="filter-select">
                        <option value="true">Bật</option>
                        <option value="false">Tắt</option>
                    </select>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn cancel-btn" data-modal-close>Hủy</button>
                <button type="submit" form="updateTrangThaiForm" class="modal-btn confirm-btn">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal cập nhật trạng thái đề xuất hàng loạt -->
<div class="modal" id="updateTrangThaiDeXuatModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cập nhật trạng thái đề xuất</h5>
                <button type="button" class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <form id="updateTrangThaiDeXuatForm" method="post" asp-action="CapNhatTrangThaiDeXuat" asp-controller="DanhMuc">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="selectedDanhMucMaDM" id="selectedDanhMucMaDMDeXuat" />
                    <p>Các danh mục được chọn sẽ được cập nhật sang trạng thái đề xuất mới.</p>
                    <label for="newTrangThaiDeXuat">Chọn trạng thái mới:</label>
                    <select name="newTrangThaiDeXuat" id="newTrangThaiDeXuat" class="filter-select">
                        <option value="true">Bật</option>
                        <option value="false">Tắt</option>
                    </select>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn cancel-btn" data-modal-close>Hủy</button>
                <button type="submit" form="updateTrangThaiDeXuatForm" class="modal-btn confirm-btn">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal thông báo cập nhật -->
<div class="modal" id="thongBaoModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cập Nhật Thành Công</h5>
                <button type="button" class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <p id="thongBaoTinNhan"></p>
                <ul id="danhSachCapNhat"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn cancel-btn" data-modal-close>Đóng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            const nhapTuKhoa = $("#nhapTuKhoa");
            const danhSachGoiY = $("#danhSachGoiY");

            // Tìm kiếm gợi ý
            nhapTuKhoa.on("input", function () {
                const tuKhoa = $(this).val().trim();
                const filter = "@ViewData["chonTrangThai"]";
                const filterDeXuat = "@ViewData["chonDeXuat"]";
                if (tuKhoa.length > 0) {
                    $.ajax({
                        url: "@Url.Action("SearchSuggestions", "DanhMuc")",
                        type: "GET",
                        data: { term: tuKhoa, chonTrangThai: filter, chonDeXuat: filterDeXuat },
                        success: function (danhSach) {
                            danhSachGoiY.empty();
                            if (danhSach.length > 0) {
                                danhSach.forEach(danhmuc => {
                                    danhSachGoiY.append(`
                                        <div class="suggestion-item">
                                            <strong>${danhmuc.tenDM}</strong>
                                        </div>
                                    `);
                                });
                                danhSachGoiY.addClass("show");
                            } else {
                                danhSachGoiY.removeClass("show");
                            }
                        },
                        error: function () {
                            danhSachGoiY.empty().removeClass("show");
                        }
                    });
                } else {
                    danhSachGoiY.empty().removeClass("show");
                }
            });

            $(document).click(function (e) {
                if (!nhapTuKhoa.is(e.target) && !danhSachGoiY.is(e.target) && danhSachGoiY.has(e.target).length === 0) {
                    danhSachGoiY.removeClass("show");
                }
            });

            // Chọn tất cả
            $("#selectAll").on("change", function () {
                $(".select-item").prop("checked", this.checked);
                toggleButtons();
            });

            // Chọn từng danh mục
            $(".select-item").on("change", function () {
                toggleButtons();
            });

            // Kích hoạt/vô hiệu hóa nút
            function toggleButtons() {
                const anyChecked = $(".select-item:checked").length > 0;
                $("#deleteSelectedBtn").prop("disabled", !anyChecked);
                $("#updateTrangThaiBtn").prop("disabled", !anyChecked);
                $("#updateTrangThaiDeXuatBtn").prop("disabled", !anyChecked);
            }

            // Xử lý nút xóa nhiều
            $("#deleteSelectedBtn").on("click", function () {
                $("#confirmDeleteModal").addClass("show");
                const selectedItems = $(".select-item:checked");
                const danhmucToDelete = $("#danhmucToDelete");
                const danhmucToHide = $("#danhmucToHide");
                danhmucToDelete.empty();
                danhmucToHide.empty();

                const selectedIds = [];
                selectedItems.each(function () {
                    selectedIds.push($(this).val());
                });

                $.ajax({
                    url: "@Url.Action("CheckDanhMucInSanPham", "DanhMuc")",
                    type: "POST",
                    data: { selectedDanhMucMaDM: selectedIds },
                    success: function (result) {
                        result.forEach(danhmuc => {
                            const li = `<li>ID: ${danhmuc.maDM} - Tên: ${danhmuc.tenDM}</li>`;
                            if (danhmuc.hasSanPham) {
                                danhmucToHide.append(li);
                            } else {
                                danhmucToDelete.append(li);
                            }
                        });
                    }
                });
            });

            // Modal trạng thái hiển thị
            $(".status-link[data-status]").on("click", function (e) {
                e.preventDefault();
                const maDM = $(this).data("id");
                const status = $(this).data("status");
                $("#statusId").val(maDM);
                $("#currentStatus").text(status ? "Bật" : "Tắt");
                $("#statusSelect").val(status ? "true" : "false");
                $("#statusModal").addClass("show");
            });

            $("#updateStatusBtn").on("click", function () {
                const formData = $("#statusForm").serialize();
                const maDM = $("#statusId").val();
                const newStatus = $("#statusSelect").val() === "true";

                $.ajax({
                    url: "@Url.Action("ChangeStatus", "DanhMuc")",
                    type: "POST",
                    data: formData,
                    success: function (response) {
                        if (response.success) {
                            const statusLink = $(`a[data-id="${maDM}"][data-status]`);
                            statusLink.text(newStatus ? "Bật" : "Tắt");
                            statusLink.removeClass("status-on status-off").addClass(newStatus ? "status-on" : "status-off");
                            statusLink.attr("data-status", newStatus);
                            $("#statusModal").removeClass("show");
                        } else {
                            alert("Có lỗi xảy ra: " + response.message);
                        }
                    },
                    error: function () {
                        alert("Lỗi khi gửi yêu cầu cập nhật trạng thái.");
                    }
                });
            });

            // Modal trạng thái đề xuất
            $(".status-link[data-dexuat]").on("click", function (e) {
                e.preventDefault();
                const maDM = $(this).data("id");
                const deXuat = $(this).data("dexuat");
                $("#deXuatId").val(maDM);
                $("#currentDeXuat").text(deXuat ? "Bật" : "Tắt");
                $("#deXuatSelect").val(deXuat ? "true" : "false");
                $("#deXuatModal").addClass("show");
            });

            $("#updateDeXuatBtn").on("click", function () {
                const formData = $("#deXuatForm").serialize();
                const maDM = $("#deXuatId").val();
                const newDeXuat = $("#deXuatSelect").val() === "true";

                $.ajax({
                    url: "@Url.Action("ChangeDeXuat", "DanhMuc")",
                    type: "POST",
                    data: formData,
                    success: function (response) {
                        if (response.success) {
                            const statusLink = $(`a[data-id="${maDM}"][data-dexuat]`);
                            statusLink.text(newDeXuat ? "Bật" : "Tắt");
                            statusLink.removeClass("status-on status-off").addClass(newDeXuat ? "status-on" : "status-off");
                            statusLink.attr("data-dexuat", newDeXuat);
                            $("#deXuatModal").removeClass("show");
                        } else {
                            alert("Có lỗi xảy ra: " + response.message);
                        }
                    },
                    error: function () {
                        alert("Lỗi khi gửi yêu cầu cập nhật trạng thái đề xuất.");
                    }
                });
            });

            // Cập nhật trạng thái hiển thị hàng loạt
            $("#updateTrangThaiBtn").on("click", function () {
                $("#updateTrangThaiModal").addClass("show");
                const selectedItems = $(".select-item:checked");
                const selectedIds = [];
                selectedItems.each(function () {
                    selectedIds.push($(this).val());
                });
                $("#selectedDanhMucMaDMTrangThai").val(selectedIds.join(","));
            });

            $("#updateTrangThaiForm").on("submit", function (e) {
                e.preventDefault();
                const formData = $(this).serialize();

                $.ajax({
                    url: "@Url.Action("CapNhatTrangThai", "DanhMuc")",
                    type: "POST",
                    data: formData,
                    success: function (response) {
                        if (response.success) {
                            response.updatedDanhMuc.forEach(danhmuc => {
                                const row = $(`tr[data-category-id="${danhmuc.maDM}"]`);
                                const statusLink = row.find(".status-link[data-status]");
                                statusLink.text(danhmuc.trangThaiMoi);
                                statusLink.removeClass("status-on status-off").addClass(danhmuc.trangThaiMoi === "Bật" ? "status-on" : "status-off");
                                statusLink.attr("data-status", danhmuc.trangThaiMoi === "Bật");
                            });
                            $("#updateTrangThaiModal").removeClass("show");
                            $("#thongBaoTinNhan").text(response.message);
                            const danhSach = $("#danhSachCapNhat");
                            danhSach.empty();
                            response.updatedDanhMuc.forEach(danhmuc => {
                                danhSach.append(`
                                    <li>ID: ${danhmuc.maDM} - ${danhmuc.tenDM}: ${danhmuc.trangThaiCu} → ${danhmuc.trangThaiMoi}</li>
                                `);
                            });
                            $("#thongBaoModal").addClass("show");
                        } else {
                            alert("Có lỗi xảy ra: " + response.message);
                        }
                    },
                    error: function () {
                        alert("Lỗi khi gửi yêu cầu cập nhật trạng thái hiển thị.");
                    }
                });
            });

            // Cập nhật trạng thái đề xuất hàng loạt
            $("#updateTrangThaiDeXuatBtn").on("click", function () {
                $("#updateTrangThaiDeXuatModal").addClass("show");
                const selectedItems = $(".select-item:checked");
                const selectedIds = [];
                selectedItems.each(function () {
                    selectedIds.push($(this).val());
                });
                $("#selectedDanhMucMaDMDeXuat").val(selectedIds.join(","));
            });

            $("#updateTrangThaiDeXuatForm").on("submit", function (e) {
                e.preventDefault();
                const formData = $(this).serialize();

                $.ajax({
                    url: "@Url.Action("CapNhatTrangThaiDeXuat", "DanhMuc")",
                    type: "POST",
                    data: formData,
                    success: function (response) {
                        if (response.success) {
                            response.updatedDanhMuc.forEach(danhmuc => {
                                const row = $(`tr[data-category-id="${danhmuc.maDM}"]`);
                                const statusLink = row.find(".status-link[data-dexuat]");
                                statusLink.text(danhmuc.trangThaiDeXuatMoi);
                                statusLink.removeClass("status-on status-off").addClass(danhmuc.trangThaiDeXuatMoi === "Bật" ? "status-on" : "status-off");
                                statusLink.attr("data-dexuat", danhmuc.trangThaiDeXuatMoi === "Bật");
                            });
                            $("#updateTrangThaiDeXuatModal").removeClass("show");
                            $("#thongBaoTinNhan").text(response.message);
                            const danhSach = $("#danhSachCapNhat");
                            danhSach.empty();
                            response.updatedDanhMuc.forEach(danhmuc => {
                                danhSach.append(`
                                    <li>ID: ${danhmuc.maDM} - ${danhmuc.tenDM}: ${danhmuc.trangThaiDeXuatCu} → ${danhmuc.trangThaiDeXuatMoi}</li>
                                `);
                            });
                            $("#thongBaoModal").addClass("show");
                        } else {
                            alert("Có lỗi xảy ra: " + response.message);
                        }
                    },
                    error: function () {
                        alert("Lỗi khi gửi yêu cầu cập nhật trạng thái đề xuất.");
                    }
                });
            });

            // Đóng modal
            $("[data-modal-close]").on("click", function () {
                $(this).closest(".modal").removeClass("show");
            });

            // Đóng modal khi click bên ngoài
            $(".modal").on("click", function (e) {
                if ($(e.target).hasClass("modal")) {
                    $(this).removeClass("show");
                }
            });
        });
    </script>
}