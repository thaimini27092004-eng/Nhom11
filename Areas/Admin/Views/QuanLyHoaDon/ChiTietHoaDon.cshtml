@*QuanLyHoaDon/ChiTietHoaDon.cshtml*@

@model WebsiteBanHang.Models.HoaDon
@{
    ViewData["Title"] = "Chi Tiết Hóa Đơn";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<link rel="stylesheet" href="~/css/Admin_QuanLyHoaDon.css">

<div class="content-wrapper">
    <div class="content-title">
        Chi tiết hóa đơn #@Model.SoHD
        <span class="status-badge status-@Model.LichSuTTHD.FirstOrDefault()?.MaTT">@(Model.LichSuTTHD.FirstOrDefault()?.TrangThai?.TenTT ?? "Không xác định")</span>
    </div>

    <!-- Thông tin giao hàng -->
    <div class="card-block">
        <h3 class="card-title">Thông tin giao hàng</h3>
        <div class="info-pair">
            <span class="info-label">Địa chỉ</span>
            <span class="info-value">@(Model.DiaChiGiaoHang ?? "Chưa cập nhật địa chỉ")</span>
        </div>
        <div class="info-pair">
            <span class="info-label">Số điện thoại</span>
            <span class="info-value">@(Model.DTNhanHang ?? "Chưa cập nhật số điện thoại")</span>
        </div>
    </div>

    <!-- Thông tin hóa đơn -->
    <div class="card-block">
        <h3 class="card-title">Thông tin hóa đơn</h3>
        <div class="info-pair">
            <span class="info-label">Số HĐ</span>
            <span class="info-value">@Model.SoHD</span>
        </div>
        <div class="info-pair">
            <span class="info-label">Ngày đặt</span>
            <span class="info-value">@Model.NgayDat.ToString("dd/MM/yyyy")</span>
        </div>
        <div class="info-pair">
            <span class="info-label">Ngày giao dự kiến</span>
            <span class="info-value">@Model.NgayGiaoDuKien.ToString("dd/MM/yyyy")</span>
        </div>
        <div class="info-pair">
            <span class="info-label">Phương thức thanh toán</span>
            <span class="info-value">@(Model.PTTT?.TenPT ?? "Không xác định") (Mã PT: @Model.MaPT)</span>
        </div>
        <div class="info-pair">
            <span class="info-label">Trạng thái</span>
            <span class="info-value">@(Model.LichSuTTHD.FirstOrDefault()?.TrangThai?.TenTT ?? "Không xác định") (Mã TT: @Model.LichSuTTHD.FirstOrDefault()?.MaTT)</span>
        </div>
        <div class="info-pair">
            <span class="info-label">Khách hàng</span>
            <span class="info-value">@(Model.KhachHang?.TenKH ?? "Không xác định") (Mã KH: @Model.MaKH)</span>
        </div>
    </div>

    <!-- Mốc thời gian trạng thái -->
    <div class="order-timeline-container">
        <h3 class="card-title">Theo dõi trạng thái đơn hàng</h3>
        <div class="timeline-wrapper">
            <!-- Progress Bar -->
            @{
                var orderedStatus = Model.LichSuTTHD.OrderBy(ls => ls.ThoiGianThayDoi).ToList();
                var totalSteps = orderedStatus.Count;
                var completedSteps = orderedStatus.Count(s => s.MaTT <= orderedStatus.Last().MaTT);
                var progressPercentage = totalSteps > 0 ? (completedSteps * 100.0 / totalSteps) : 0;
            }
            <div class="timeline-progress">
                <div class="timeline-progress-bar" style="width: @progressPercentage%;"></div>
            </div>

            <!-- Timeline Steps -->
            <div class="timeline-steps">
                @foreach (var status in orderedStatus)
                {
                    var isCompleted = status.MaTT <= orderedStatus.Last().MaTT;
                    var isActive = status == orderedStatus.Last();
                    // Sử dụng UrlAnh từ TrangThai, nếu không có thì dùng ảnh mặc định
                    var iconPath = string.IsNullOrEmpty(status.TrangThai?.UrlAnh)
                    ? "~/images/GiaoHang/IconDefault.png"
                    : status.TrangThai.UrlAnh;
                    <div class="timeline-step @(isCompleted ? "completed" : "") @(isActive ? "active" : "")">
                        <div class="timeline-step-icon">
                            <img src="@Url.Content(iconPath)" alt="@status.TrangThai.TenTT" />
                        </div>
                        <p class="timeline-step-status">@status.TrangThai.TenTT</p>
                        <p class="timeline-step-time">@status.ThoiGianThayDoi.ToString("dd/MM/yyyy HH:mm")</p>
                        @if (!string.IsNullOrEmpty(status.GhiChu))
                        {
                            <div class="timeline-step-tooltip">@status.GhiChu</div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Danh sách sản phẩm -->
    <div class="table-container">
        <h3 class="card-title">Danh sách sản phẩm</h3>
        @if (Model.CTHDs != null && Model.CTHDs.Any())
        {
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ảnh</th>
                        <th>Tên sản phẩm</th>
                        <th>Số lượng</th>
                        <th>Đơn giá</th>
                        <th>Tổng tiền</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var chiTiet in Model.CTHDs)
                    {
                        <tr>
                            <td>
                                <img src="@(chiTiet.TonKho.SanPham?.UrlAnh ?? "https://via.placeholder.com/50x50")"
                                     alt="@chiTiet.TonKho.SanPham?.TenSP"
                                     class="product-image" />
                            </td>
                            <td>@chiTiet.TonKho.SanPham?.TenSP</td>
                            <td>@chiTiet.SL</td>
                            <td>@chiTiet.DonGia.ToString("N0") Vnđ</td>
                            <td>@((chiTiet.SL * chiTiet.DonGia).ToString("N0")) Vnđ</td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" class="text-end"><strong>Tổng cộng:</strong></td>
                        <td><strong>@Model.CTHDs.Sum(ct => ct.SL * ct.DonGia).ToString("N0") Vnđ</strong></td>
                    </tr>
                </tfoot>
            </table>
        }
        else
        {
            <p class="alert alert-error">Không có sản phẩm nào trong hóa đơn này.</p>
        }
    </div>
</div>

<!-- Nút hành động -->
<div class="action-bar">
    <a href="@Url.Action("DanhSachHoaDon", "QuanLyHoaDon", new { area = "Admin" })" class="action-btn primary-btn">
        <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 18L9 12L15 6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        Quay lại
    </a>
    <button type="button" class="action-btn" disabled>In hóa đơn</button>
</div>